<% if (theme.comment.livere.enable && theme.comment.livere.uid) { %>
    <div id="lv-container" class="mdui-color-white mdui-p-x-3 mdui-p-b-3" data-id="city" data-uid="<%= theme.comment.livere.uid %>">
        <script>
            (() => {
                const script = document.createElement('script');
                script.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                script.async = true;
                document.body.appendChild(script);
            })()
        </script>
    </div>
<% } %>

<% if (theme.comment.artalk.enable) { %>
    <div id="artalk-container" class="mdui-typo mdui-p-x-3 mdui-p-b-3" style="box-sizing:border-box"></div>
    <script>
        (() => {
            const t = document.createElement('link');
            t.rel = 'stylesheet';
            t.href = '<%= theme.comment.artalk.stylesheet || 'https://cdn.jsdelivr.net/npm/artalk@2/dist/Artalk.css' %>';
            const s = document.createElement('style');
            s.innerHTML = '.atk-comment > .atk-main > .atk-body img:not([atk-emoticon]){max-height:160px}' + [
                ['red','#ff5252','#ff8a80'],
                ['pink','#ff4081','#ff80ab'],
                ['purple','#e040fb','#ea80fc'],
                ['deep-purple','#7c4dff','#b388ff'],
                ['indigo','#536dfe','#8c9eff'],
                ['blue','#448aff','#82b1ff'],
                ['light-blue','#40c4ff','#80d8ff'],
                ['cyan','#18ffff','#84ffff'],
                ['teal','#64ffda','#a7ffeb'],
                ['green','#69f0ae','#b9f6ca'],
                ['light-green','#b2ff59','#ccff90'],
                ['lime','#eeff41','#f4ff81'],
                ['yellow','#ffff00','#ffff8d'],
                ['amber','#ffd740','#ffe57f'],
                ['orange','#ffab40','#ffd180'],
                ['deep-orange','#ff6e40','#ff9e80'],
            ].map(([t,m,l]) => `.mdui-theme-accent-${t} .artalk,.mdui-theme-accent-${t} .artalk-layer-wrap,.mdui-theme-accent-${t} .artalk.atk-dark-mode,.mdui-theme-accent-${t} .artalk-layer-wrap.atk-dark-mode{--at-color-main:${m};--at-color-light:${l}}`).join('');
            const e = document.createElement('script');
            e.src = '<%= theme.comment.artalk.script || 'https://cdn.jsdelivr.net/npm/artalk@2/dist/Artalk.js' %>';
            e.async = true;
            e.onload = () => {
                // LaTex公式渲染，使用第三方API而不是katex
                // https://github.com/ArtalkJS/Artalk/blob/master/ui/plugin-katex/src/main.ts
                Artalk.use(ctx => {
                    let index = 0;
                    const next = () => `__atk_tex_id_${index++}__`;
                    /** @type {Record<String, { isBlock: Boolean; tex: String }>} */
                    const texExprs = {};

                    /**
                     * @param tex {String}
                     * @param isBlock {Boolean}
                     * @returns
                     */
                    const getPlaceholder = (tex, isBlock) => {
                        const key = next();
                        texExprs[key] = { tex, isBlock };
                        return key;
                    };

                    const blockMathExtension = {
                        name: 'blockMath',
                        level: 'block',
                        /**
                         * @param src {String}
                         * @returns
                         */
                        tokenizer: src => {
                            const cap = /^(?:\s{0,3})\$\$((?:[^\n]|\n[^\n])+?)\n{0,1}\$\$/.exec(src);
                            if (cap) {
                                return {
                                    type: 'html',
                                    raw: cap[0],
                                    text: getPlaceholder(cap[1], true),
                                };
                            }
                        },
                    }

                    const inlineMathExtension = {
                        name: 'inlineMath',
                        level: 'inline',
                        /**
                         * @param src {String}
                         * @returns
                         */
                        start: src => {
                            const idx = src.search(/\$.*?\$/);
                            return idx !== -1 ? idx : src.length;
                        },
                        /**
                         * @param src {String}
                         * @returns
                         */
                        tokenizer: src => {
                            const cap = /^\$(.*?)\$/.exec(src);
                            if (cap) {
                                return {
                                    type: 'html',
                                    raw: cap[0],
                                    text: getPlaceholder(cap[1], false),
                                };
                            }
                        },
                    }

                    ctx.on('mounted', () => {
                        ctx.getMarked().use({ extensions: [blockMathExtension, inlineMathExtension] });
                        ctx.updateConf({
                            markedReplacers: [
                                text => {
                                    text = text.replace(/(__atk_tex_id_\d+__)/g, (_, key) =>  {
                                        const { tex, isBlock } = texExprs[key];
                                        delete texExprs[key];
                                        const src = `https://www.zhihu.com/equation?tex=${encodeURIComponent(tex)}`;
                                        return isBlock
                                            ? `<p style="text-align:center"><img src="${src}"></p>`
                                            : `<img style="vertical-align:middle" src="${src}">`;
                                    })
                                    return text;
                                },
                            ],
                        });
                    });
                });
                Artalk.use(ctx => ctx.on('list-loaded', () => ctx.getCommentNodes().forEach(e => Array.from(e.getRender().$content.querySelectorAll('img:not([atk-emoticon])')).forEach(e => {
                    e.classList.add('mdui-img-rounded');
                    mediumZoom(e, {
                        margin: 16,
                        scrollOffset: 8,
                        background: 'rgba(0,0,0,.85)',
                    });
                }))));
                Artalk.init({
                    el: '#artalk-container',
                    server: '<%= theme.comment.artalk.server %>',
                    site: '<%= theme.comment.artalk.site || config.title %>',
                });
            };
            document.head.appendChild(t);
            document.head.appendChild(s);
            document.body.appendChild(e);
        })()
    </script>
<% } %>